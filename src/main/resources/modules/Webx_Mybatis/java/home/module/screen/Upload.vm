package ${basePackage}.home.module.screen;

import com.alibaba.citrus.service.requestcontext.buffered.BufferedRequestContext;
import com.alibaba.citrus.turbine.dataresolver.Param;
import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.serializer.ValueFilter;
import org.apache.commons.fileupload.FileItem;
import org.springframework.beans.factory.annotation.Autowired;
import ${basePackage}.framework.BaseResponse;
import ${basePackage}.framework.ErrorType;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.io.PrintWriter;

/**
 * 上传接口
 *
 * @author
 * @date 2017-01-01
 */
public class Upload {

    @Autowired
    private HttpServletRequest httpServletRequest;
    @Autowired
    private HttpServletResponse httpServletResponse;
    @Autowired
    private BufferedRequestContext brc;

    public void execute(@Param("file") FileItem fileItem) {

        BaseResponse baseResponse = new BaseResponse();
        try {
            // 必须关闭buffering，未完成的页面才会被显示在浏览器上。
            brc.setBuffering(false);
            // 设置content type，但不需要设置charset，框架会设置正确的charset。
            httpServletResponse.setContentType("text/plain");

            if (fileItem == null) {
                baseResponse.addError(ErrorType.BUSINESS_ERROR, "上传文件不能为空!");
            }

        } finally {
            try {
                String jsonTenant = JSON.toJSONString(baseResponse, new ValueFilter() {
                    @Override
                    public Object process(Object o, String s, Object o1) {
                        if (o1 instanceof Long) {
                            Long o11 = (Long) o1;
                            return String.valueOf(o11);
                        }
                        return o1;
                    }
                });
                PrintWriter out = httpServletResponse.getWriter();
                out.println(jsonTenant);
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }

}